{% extends "base.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
{% endblock %}

{% block css %}
#mynetwork {
    width: 100%;
    height: 100vh;
    border: 1px solid #ddd;
    background-color: #f8f9fa;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.search-container {
    position: absolute;
    bottom: 100px;
    left: 10px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.search-container input,
.search-container select,
.search-container button {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
}
.search-container button {
    background-color: #007bff;
    color: white;
    cursor: pointer;
}
.search-container button:hover {
    background-color: #0056b3;
}
#node-info {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background-color: rgba(255,255,255,0.95);
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-size: 14px;
    color: #333;
    width: 260px;
    max-height: 250px;
    overflow-y: auto;
}
#legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 14px;
}
.legend-box {
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-right: 5px;
    border-radius: 3px;
}
{% endblock %}

{% block body %}
<div id="mynetwork"></div>

<div class="search-container">
    <label for="channel-select" style="color:#333;">Channel:</label>
    <select id="channel-select" onchange="filterByChannel()"></select>
    <input type="text" id="node-search" placeholder="Search node...">
    <button onclick="searchNode()">Search</button>
</div>

<div id="node-info">
    <b>Long Name:</b> <span id="node-long-name"></span><br>
    <b>Short Name:</b> <span id="node-short-name"></span><br>
    <b>Role:</b> <span id="node-role"></span><br>
    <b>Hardware Model:</b> <span id="node-hw-model"></span>
</div>

<div id="legend">
    <div><span class="legend-box" style="background-color:#ff5733;"></span> Traceroute</div>
    <div><span class="legend-box" style="background-color:#3388ff;"></span> Neighbor</div>
</div>

<script>
const chart = echarts.init(document.getElementById('mynetwork'));

// --- Nodes ---
const nodes = [
{% for node in nodes %}
{
    name: "{{ node.node_id }}",                // node_id as string
    value: {{ node.long_name | tojson }},     // display label
    symbol: 'circle',
    symbolSize: 15,
    itemStyle: { color:'#007bff', opacity:1 },
    label: { show:true, position:'right', color:'#333', fontSize:12, formatter: (p)=>p.data.value },
    long_name: {{ node.long_name | tojson }},
    short_name: {{ node.short_name | tojson }},
    role: {{ node.role | tojson }},
    hw_model: {{ node.hw_model | tojson }},
    channel: {{ node.channel | tojson }}
}{% if not loop.last %},{% endif %}
{% endfor %}
];

// --- Edges ---
const edges = [
{% for edge in edges %}
{
    source: "{{ edge.from }}",   // edge source as string
    target: "{{ edge.to }}",     // edge target as string
    originalColor: "{{ edge.originalColor }}"
}{% if not loop.last %},{% endif %}
{% endfor %}
];

let filteredNodes = [];
let filteredEdges = [];
let selectedChannel = 'LongFast';
let lastSelectedNode = null;

function populateChannelDropdown() {
    const sel = document.getElementById('channel-select');
    const unique = [...new Set(nodes.map(n=>n.channel).filter(Boolean))].sort();
    unique.forEach(ch=>{
        const opt = document.createElement('option');
        opt.value=ch; opt.text=ch;
        if(ch==='LongFast') opt.selected=true;
        sel.appendChild(opt);
    });
    selectedChannel = sel.value;
    filterByChannel();
}

function filterByChannel() {
    selectedChannel = document.getElementById('channel-select').value;
    filteredNodes = nodes.filter(n=>n.channel===selectedChannel);
    const nodeSet = new Set(filteredNodes.map(n=>n.name));
    filteredEdges = edges.filter(e=>nodeSet.has(e.source) && nodeSet.has(e.target));
    lastSelectedNode=null;
    updateChart();
}

function updateChart() {
    const updatedNodes = filteredNodes.map(node=>{
        let opacity=1, color='#007bff';
        if(lastSelectedNode){
            const connected = filteredEdges.some(e=>
                (e.source===node.name && e.target===lastSelectedNode) ||
                (e.target===node.name && e.source===lastSelectedNode)
            );
            if(node.name===lastSelectedNode){ color='#ff8c00'; opacity=1; }
            else if(connected) opacity=1;
            else opacity=0.4;
        }
        return {...node, itemStyle:{color,opacity}};
    });

    const updatedEdges = filteredEdges.map(edge=>{
        let opacity=0.1, width=2;
        if(lastSelectedNode){
            const connected = edge.source===lastSelectedNode || edge.target===lastSelectedNode;
            opacity=connected?1:0.05; width=connected?2:1;
        }
        return {...edge, lineStyle:{color:edge.originalColor||'#d3d3d3', width, opacity}};
    });

    chart.setOption({series:[{type:'graph', layout:'force', data:updatedNodes, links:updatedEdges, roam:true, force:{repulsion:200, edgeLength:[80,120]}}]});
}

chart.on('click', function(params){
    if(params.dataType==='node') updateSelectedNode(params.data.name);
    else{
        lastSelectedNode=null; updateChart();
        document.getElementById('node-long-name').innerText='';
        document.getElementById('node-short-name').innerText='';
        document.getElementById('node-role').innerText='';
        document.getElementById('node-hw-model').innerText='';
    }
});

function updateSelectedNode(selNode){
    lastSelectedNode=selNode; updateChart();
    const n = filteredNodes.find(x=>x.name===selNode);
    if(n){
        document.getElementById('node-long-name').innerText=n.long_name;
        document.getElementById('node-short-name').innerText=n.short_name;
        document.getElementById('node-role').innerText=n.role;
        document.getElementById('node-hw-model').innerText=n.hw_model;
    }
}

function searchNode(){
    const q = document.getElementById('node-search').value.toLowerCase().trim();
    if(!q) return;
    const found = filteredNodes.find(n=>n.name.toLowerCase().includes(q) || n.long_name.toLowerCase().includes(q) || n.short_name.toLowerCase().includes(q));
    if(found) updateSelectedNode(found.name);
    else alert("Node not found in current channel!");
}

populateChannelDropdown();
window.addEventListener('resize', ()=>chart.resize());
</script>
{% endblock %}
